[![Build Status](https://travis-ci.org/RevolutionRobotics/RevvyFirmware.svg?branch=master)](https://travis-ci.org/RevolutionRobotics/RevvyFirmware)

RevvyFirmware
==============

This repository contains the application code running on the ATSAMD51P19A microcontroller on the Revolution Robotics Challenge Kit's control board.
This firmware was built using CGlue, an in-house developed firmware architecture and toolkit. Most of the custom-developed firmware is organized into
software components that are connected by a runtime layer generated by CGlue. The component models are individually described in the components' folders,
the port connections are configured in the `project.json` file in the root folder.
Because CGlue is missing some features, some of the software components contain manual modifications to the generated component structure or runtime layer.
An example for this is the communication layer: currently, it is not possible to describe, which command IDs belong to which command handler functions,
so these connections are done in a manually written source file.
One of the end goals of the CGlue-based application was to create software components that are independent of the underlying hardware and so they are
portable and testable. Due to time and resource constraints, this goal has not been met.

The other substantial part of the firmware is the code provided by Atmel/Microchip. Some of their SDK is used as-is, but other parts, for example the
SERCOM codes have been modified, replaced or removed from the package.

The application code contains error logging. Log entries are made on hard fault exceptions and assert failures (in debug configuration). To read and clear
log entries, you can use the provided tools in the RevvyFirmware repository.


Developing with CGlue
--------------------

* Create a new software component: `cglue --new-component ComponentName`
* Update generated component code based on modification of the component model: `cglue --update-component ComponentName [--cleanup]`
* Generate runtime based on the project.json configuration: `cglue --generate --cglue-output=rrrc/generated_runtime [--cleanup]`
  The generated files are: `rrrc/generated_runtime.h` and `rrrc/generated_runtime.c`
* Generate makefile for compilation: `python -m tools.generate_makefile [--cleanup]`

When using the provided VS Code tasks, runtime and makefile generation is done automatically during the build process.


Building the firmware
---------------------

### Tools required:
 - git
 - ARM GCC,
 - python 3.7
 - VS Code if you intend to keep your sanity
   - [Cortex-Debug](https://github.com/Marus/cortex-debug) to allow debugging in VS Code
 - python 3.7 or newer
 - SEGGER J-Link drivers (optional for debugging)

### Instructions for Microsoft Windows:
 - ~~Download and install version 9-2019-q4-major of the ARM GCC toolchain from https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads~~.
   - Linux: `sudo apt install build-essential gcc-arm-none-eabi`
   - Windows: [download & install](https://dev.to/gamegods3/how-to-install-gcc-in-windows-10-the-easier-way-422j)
     - Download the binary and dependencies from http://gnuwin32.sourceforge.net/packages/make.htm
     - Extract the downloaded directories to a place of your choice. (For example, C:\gnu\make)
     - Add the bin folder of the extracted archive to your Path.
     - Make sure the folder contains the compiler binaries are included in your Path.
 - To debug the firmware using a J-Link probe, download and install [SEGGER J-Link drivers](https://www.segger.com/downloads/jlink/)

### Create python virtual environment and install requirements
 - open a command line in the project directory
 - Run command `[python -m venv venv](https://www.segger.com/downloads/jlink/)` to create new virtual environment in the `venv` directory
 - Activate virtual environment by running
   - Windows: `.\venv\Scripts\activate`
   - Linux: `source ./venv/bin/activate`
 - Run command `pip install -r tools/requirements.txt`

### Install the firmware on a working robot:
 - In VS Code, select `Terminal > Run Task... > prepare release binary`
 - If successful, you should see the name, version, size and checksum of the resulting binary.
   You will find the binary in `Build/output`.
    Example:

    ```
    Changes made to catalog file:
      Deleted old firmware: revvy_firmware-0.2.1142.bin
      Added: revvy_firmware-0.2.1151-develop.bin - HW: 2.0.0, FW: 0.2.1151-develop, size: 70228, md5: dfc5298fb025e7edafb4bf6374962552
    ```

  - Connect to the robot. Consult the framework documentation for more information on this.
  - Copy the resulting binary and catalog.json to the `~/RevvyFramework/user/packages/<newest>/data/firmware/` folder
    > In case there are no folders in `~/RevvyFramework/user/packages/`, you need to copy an installation from `~/RevvyFramework/default/packages/`.
    > To do this, run the `cp -R ~/RevvyFramework/default/packages/ ~/RevvyFramework/user/packages/` command.

  - Delete the corresponding lines from the `manifest.json` file in the `~/RevvyFramework/user/packages/<newest>/` folder
  - Restart the framework to install the firmware

### Debugging
 - Make sure the debug bootloader is installed on the MCU. You can find the compiled bootloaders in the ProductionFiles repository, or the sources in the Bootloader repository.
 - Select the Run icon in the left toolbar
 - Select the `Debug (J-Link)` configuration
 - Press `F5` to start
 - If prompted, accept the licence agreement
