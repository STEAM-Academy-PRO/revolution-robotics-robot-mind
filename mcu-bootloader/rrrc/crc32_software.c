//==============================================================================
// crc32_software.h
//
// Created: 10.05.2019 15:49:09
//  Author: pkurganov
//==============================================================================

#include "crc32_software.h"

#define POLYNOMIAL      (0xEDB88320)

static uint32_t s_crc_table[256];

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
static void CRC32_GenerateTable (void) {

    for (int idx = 0; idx < 256; idx++) {

        uint8_t bit = 8;
        uint32_t val = idx;
        do {
            val = (val & 1) ? ((val >> 1) ^ POLYNOMIAL) : (val >> 1);
        } while (--bit);
        s_crc_table[idx] = val;
    }
}

//==============================================================================
// Public functions
//==============================================================================

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
void CRC32_Init (void) {

    CRC32_GenerateTable();
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
uint32_t CRC32_Calculate (const void * srcbuf, size_t bytelen, uint32_t crc32) {

    const uint8_t * srcbuf08 = (const uint8_t *) srcbuf;

    while (bytelen-- > 0u)
    {
        crc32 = s_crc_table[(crc32 ^ *srcbuf08++) & 0xFF] ^ (crc32 >> 8);
    }

    return crc32;
}
